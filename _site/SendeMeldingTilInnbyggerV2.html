<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="UTF-8">

<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>SENDE MELDING TIL INNBYGGER V2 | ePROM v11.0</title>
<meta name="generator" content="Jekyll v3.10.0" />
<meta property="og:title" content="SENDE MELDING TIL INNBYGGER V2" />
<meta property="og:locale" content="en_US" />
<link rel="canonical" href="http://localhost:4000/SendeMeldingTilInnbyggerV2.html" />
<meta property="og:url" content="http://localhost:4000/SendeMeldingTilInnbyggerV2.html" />
<meta property="og:site_name" content="ePROM v11.0" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="SENDE MELDING TIL INNBYGGER V2" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","headline":"SENDE MELDING TIL INNBYGGER V2","url":"http://localhost:4000/SendeMeldingTilInnbyggerV2.html"}</script>
<!-- End Jekyll SEO tag -->

    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link rel="preload" href="https://fonts.googleapis.com/css?family=Open+Sans:400,700&display=swap" as="style" type="text/css" crossorigin>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#157878">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="stylesheet" href="/assets/css/style.css?v=ab89dff6da65ec38e4b1c7a32b73307963685df2">
    <!-- start custom head snippets, customize with your own _includes/head-custom.html file -->

<!-- Setup Google Analytics -->



<!-- You can set your favicon here -->
<!-- link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" -->

<!-- end custom head snippets -->

  </head>
  <body>
    <a id="skip-to-content" href="#content">Skip to the content.</a>

    <header class="page-header" role="banner">
      <h1 class="project-name">SENDE MELDING TIL INNBYGGER V2</h1>
      <h2 class="project-tagline"></h2>
      
        <a href="https://github.com/HemitSystemutvikling/ePROM" class="btn">View on GitHub</a>
      
      
    </header>

    <main id="content" class="main-content" role="main">
      <h1 id="sende-melding-til-innbygger-v2">SENDE MELDING TIL INNBYGGER V2</h1>

<p><em>Sist oppdatert 18.10.2023</em></p>

<h2 id="innholdsfortegnelse">Innholdsfortegnelse</h2>

<p><a href="#sende-melding-klient-side">Sende melding klient-side</a></p>

<p><a href="#sende-melding-server-side">Sende melding server-side</a></p>

<p><a href="#Feilsituasjoner">Feilsituasjoner</a></p>

<p><a href="#mottak-av-status-for-forsendelse">Mottak av status for forsendelse</a></p>

<p>API-kallet for å sende sensitiv informasjon er i v2 endret slik at man får respons med en gang, uten å vente på at forsendelsen har gått igjennom til Helsenorge/Digipost. Når forsendelsen er fullført (pasienten har fått beskjed og brevet er tilgjengelig) vil ePROM gjøre et kall mot Bestillersystemet med status for forsendelsen. Bestillersystemet må implementere en service som mottar dette kallet.</p>

<p>Hvis man har behov for å sende sensitiv informasjon til pasienten kan man sende dette via ePROM.</p>

<p>Utsending av melding kan gjøres både fra server-side og fra klient-side. Ved kall fra server-side kan man benytte seg av et API utviklet av Hemit og distribuert som NuGet pakke for å forenkle oppkoblingen.
Alle URL’ene som er oppgitt i dette dokumentet går mot integrasjonsmiljøet for ePROM</p>

<p>Utsending av brev / melding til innbygger støtter PDF-filer på opp til 30MB</p>

<p>NB!
I verson v2 av API’et skal ApiKey sendes som en <code class="language-plaintext highlighter-rouge">Authorization</code> parameter som del av HTTP header:
<code class="language-plaintext highlighter-rouge">headers: {"Authorization": "Basic " + apiKey}</code></p>

<h2 id="sende-melding-klient-side">Sende melding klient-side</h2>

<p><strong>URL for Web API kall</strong>
[https://proms.hemitdev.org/promswebapi/api/v2/messagetocitizen]</p>

<p><strong>Parametere – Inn</strong></p>

<ul>
  <li>apiKey - ApiKey of the end user system sending the message</li>
  <li>nationalId  - The national id number of the patient the message is addressing (must be either Norsk fødselsnummer or D-nummer)</li>
  <li>senderInfo - Information about the sender</li>
  <li>messageInfo - Information about the message</li>
  <li>documentCollection – Collection of documents to send to citizen</li>
  <li>notificationPriorityList - List of channels where to send the document to the citizen <code class="language-plaintext highlighter-rouge">{ None | Helsenorge | DigitalMailbox | PhysicalMailbox | Unsecure }</code> The numeric value can be sent.</li>
  <li>testMode - Optional. Set to true when the message is initiated from ePROM Admin and the status shall not to be returned to the BestillerSystem. Default: false</li>
  <li>paperColorPrint - Optional. Set to true when paper should be printed in color. Default: false</li>
</ul>

<p><strong>Parametere – Ut</strong></p>

<ul>
  <li>notificationChannel – The channel used to send the document to the citizen <code class="language-plaintext highlighter-rouge">{ None | Helsenorge | DigitalMailbox | PhysicalMailbox | Unsecure }</code></li>
  <li>messageToCitizenId – The Id of the message</li>
</ul>

<p><strong>Metode</strong></p>

<p>POST</p>

<h2 id="sende-melding-server-side">Sende melding server-side</h2>

<p><strong>API</strong></p>

<p>Tilgjenglig som NuGet pakke</p>

<p><a href="https://pkgs.dev.azure.com/hemit/a7f87e1f-3406-4ac2-a2d4-18e789c37706/_packaging/Hemit_public_packages/nuget/v3/index.json">NuGet repository</a></p>

<p>Navn: Hemit.ePROM.Integration</p>

<p>Eksempelkode (C#)</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[HttpPost]
public JsonResult SendMessageToCitizenV2(string nationalId, DocumentCollection documentCollection)
{
// &lt;add key="PromsApiBaseUrl" value="http://proms.hemitdev.org/promswebapi/" /&gt;
var promsApiBaseUrl = ConfigurationManager. AppSettings["PromsApiBaseUrl"]; 
var apikey = ConfigurationManager. AppSettings["ApiKey"]; 
var messageInfo = new MessageInfo {

    title = "Ikkesensitiv tittel på melding",
    description = "Beskrivelse av melding",
    merknad = "Helseundersøkelsene i Nord Trøndelag - HUNT"

}; 
var senderInfo = new SenderInfo {

    organisationName = "Navn på organisasjon",
    organisationNr = "Organisasjon nr"

}; 
var notificationPriorityList = new List&lt;NotificationChannel&gt;
{

    NotificationChannel.Helsenorge,
    NotificationChannel.DigitalMailbox

}; 

    var result = Api.SendMessageToCitizenV2(

promsApiBaseUrl, 
apikey, 
nationalId, 
senderInfo, 
messageInfo, 
documentCollection, 
notificationPriorityList,
false); 

    if (result.HasErrors)
    {
        Response.StatusCode = result.ErrorStatusCode.Value;
        Response.Write(result.ErrorJson);
        return null;
    }

    return Json(new { 
notificationChannel = result.NotificationChannel,
messageToCitizenId = result.messageToCitizenId}); 
}
</code></pre></div></div>

<p><strong>Parametere - Inn</strong></p>

<ul>
  <li>promsApiBaseUrl - The base URL of the PROMS API</li>
  <li>apiKey - ApiKey of the end user system sending the message</li>
  <li>nationalId - The national id number of the patient the message is addressing (must be either Norsk fødselsnummer or D-nummer)</li>
  <li>senderInfo - Information about the sender</li>
  <li>messageInfo - Information about the message</li>
  <li>documentCollection – Collection of documents to send to citizen</li>
  <li>notificationChannel - List of channels where to send the document to the citizen <code class="language-plaintext highlighter-rouge">{ None | Helsenorge | DigitalMailbox | PhysicalMailbox | Unsecure }</code> The numeric value can be sent.</li>
  <li>testMode - Optional. Set to true when the message is initiated from ePROM Admin and the status shall not to be returned to the BestillerSystem. Default: false</li>
  <li>paperColorPrint - Optional. Set to true when paper should be printed in color. Default: false</li>
</ul>

<p>promsApiBaseUrl skal være https://proms.hemitdev.org/promswebapi</p>

<p><strong>Parametere – Ut</strong></p>

<ul>
  <li>
    <p>SendMessageToCitizenResult</p>
  </li>
  <li>notificationChannel – The channel used to send the document to the citizen <code class="language-plaintext highlighter-rouge">{ None | Helsenorge | DigitalMailbox | PhysicalMailbox | Unsecure }</code></li>
  <li>messageToCitizenId – The Id of the message</li>
</ul>

<h2 id="feilsituasjoner">Feilsituasjoner</h2>

<p>Hvis responsen resulterer i <code class="language-plaintext highlighter-rouge">"notificationChannel": "0"</code> er det ikke sendt noe melding til innbygger. Dette skjer hvis ePROM ikke kan nå innbygger via helsenorge, digipost. Dette er også tilfelle hvis fødselsnummeret ikke eksisterer.</p>

<p>Ellers kan følgende feilsituasjoner oppstå:</p>

<ul>
  <li>504 GatewayTimeout, “Timeout while waiting for response from Helsenorge”</li>
  <li>502 BadGateway, “Unable to communicate with Helsenorge. No message sent.”</li>
  <li>400 BadRequest(“Main document in MessageToCitizen is missing”)</li>
  <li>400 BadRequest($”apiKey ‘{message.apiKey}’ doesn’t exists”)</li>
</ul>

<h2 id="mottak-av-status-for-forsendelse">Mottak av status for forsendelse</h2>

<p>API-kallet for å sende sensitiv informasjon er i v2 endret slik at man får respons med en gang, uten å vente på at forsendelsen har gått igjennom til Helsenorge/Digipost. Når forsendelsen er fullført (pasienten har fått beskjed og brevet er tilgjengelig) vil ePROM gjøre et kall mot Bestillersystemet med status for forsendelsen. Bestillersystemet må implementere en service som mottar dette kallet.</p>

<p><strong>URL for Web API kall</strong></p>

<p>ApiBaseUrl for web API registreres i ePROM Selvbetjeningsmodul under Bestillersystem: <a href="https://proms.hemitdev.org/PromsAdministration/">https://proms.hemitdev.org/PromsAdministration/</a></p>

<p>Web API må være tilgjenglig på URL: https:// <code class="language-plaintext highlighter-rouge">&lt;ApiBaseUrl&gt;</code> /api/MessageToCitizen</p>

<p>F.eks: [https://proms.hemitdev.org/PromsTestregisterServices/api/MessageToCitizen/]</p>

<p><strong>Parametere - Inn</strong></p>

<ul>
  <li>apiKey – ApiKey of the end user system sending the message</li>
  <li>messageToCitizenId – The Id of the message</li>
  <li>notificationChannel – The actual channel used to send the document to the citizen <code class="language-plaintext highlighter-rouge">{ None | Helsenorge | DigitalMailbox | PhysicalMailbox | Unsecure }</code></li>
  <li>sentStatus – Status of the message <code class="language-plaintext highlighter-rouge">{ Sent | Error }</code>
    <ul>
      <li>Sent – The message was successfully sent</li>
      <li>Error – The message was not successfully sent. For time being, the only reason for this is when the patient cannot be notified because there is no way to make contact.</li>
    </ul>
  </li>
</ul>

<p><strong>Parametere - Ut</strong></p>

<ul>
  <li>success – true if the request was processed successfully, otherwise false</li>
</ul>

<p>For parameter inn og ut kan NuGet pakken <em>Hemit.ePROM.Integration</em> benyttes. Bruk da <em>Hemit.ePROM.Integration.SendMessageToCitizenResult</em> for parameter inn og <em>Hemit.ePROM.Integration.SendMessageToCitizenResponse</em> for parameter ut</p>

<p><strong>Metode</strong></p>

<p>PUT</p>

<p>Eksempel request fra Proms (JSON)</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{
    "apiKey" : "",
    "messageToCitizenId" : "184738d0-3c39-e611-9c2a-34e6d72e03c7",
    "notificationChannel" : "Helsenorge",
    "sentStatus" : "Sent"
}
</code></pre></div></div>



      <footer class="site-footer">
        
          <span class="site-footer-owner"><a href="https://github.com/HemitSystemutvikling/ePROM">ePROM</a> is maintained by <a href="https://github.com/HemitSystemutvikling">HemitSystemutvikling</a>.</span>
        
        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a>.</span>
      </footer>
    </main>
  </body>
</html>
